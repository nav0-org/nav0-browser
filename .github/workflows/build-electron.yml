name: Build Electron App for All Platforms

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (leave empty to use package.json version)'
        required: false
        default: ''
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

# Add proper permissions for creating releases
permissions:
  actions: write
  contents: write
  packages: write

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - os: macos-15        # Cross-compile for x64
            platform: mac
            arch: x64
            artifact_name: macOS-x64
          - os: macos-latest    # ARM64 runner
            platform: mac
            arch: arm64
            artifact_name: macOS-arm64

          # Linux build
          - os: ubuntu-latest
            platform: linux
            arch: x64
            artifact_name: Linux-x64

          # Windows build
          - os: windows-latest
            platform: win
            arch: x64
            artifact_name: Windows-x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # Windows dependencies for electron-forge
      - name: Install Windows dependencies
        if: matrix.platform == 'win'
        shell: powershell
        run: |
          choco install 7zip -y
          echo "Windows build tools installed"

      # Linux dependencies for electron-forge
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg fakeroot rpm libnss3-dev libatk-bridge2.0-dev libdrm2 libgtk-3-dev libgbm-dev

      # Set up Python for native module compilation
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Install dependencies
      - name: Install dependencies
        run: npm ci --ignore-scripts

      # Rebuild electron-winstaller to download Squirrel vendor binaries
      # (skipped by --ignore-scripts but required for Windows installer creation)
      - name: Setup electron-winstaller
        if: matrix.platform == 'win'
        shell: bash
        run: npm rebuild electron-winstaller

      # Import Apple signing certificate (macOS only)
      - name: Import Apple signing certificate
        if: matrix.platform == 'mac' && env.CSC_LINK != ''
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Import certificate from secrets
          echo "$CSC_LINK" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$CSC_KEY_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      # Rebuild DMG native modules (macOS only)
      - name: Rebuild DMG native modules (macOS only)
        if: matrix.platform == 'mac'
        shell: bash
        run: |
          echo "Rebuilding DMG-related native modules for macOS"

          NODE_VERSION=$(node -v | sed 's/v//')
          echo "Using Node.js version: $NODE_VERSION"

          DMG_PACKAGES=("macos-alias" "fs-xattr")

          # DMG native modules (macos-alias, fs-xattr) are used by appdmg on the HOST
          # machine to create the .dmg file. They must be compiled for the host architecture,
          # not the target architecture, to avoid architecture mismatch errors when
          # cross-compiling (e.g. building x64 on an arm64 runner).
          HOST_ARCH=$(uname -m)
          if [ "$HOST_ARCH" = "arm64" ] || [ "$HOST_ARCH" = "aarch64" ]; then
            HOST_ARCH="arm64"
          else
            HOST_ARCH="x64"
          fi
          echo "Host architecture: $HOST_ARCH (target: ${{ matrix.arch }})"

          for package in "${DMG_PACKAGES[@]}"; do
            echo "Building $package for host arch ($HOST_ARCH)..."
            if [ -d "node_modules/$package" ]; then
              cd "node_modules/$package"
              rm -rf build || true
              npm install node-gyp --no-save || true
              echo "Rebuilding $package with node-gyp for host arch..."
              npx node-gyp rebuild --target=$NODE_VERSION --arch=$HOST_ARCH || \
              npm rebuild --build-from-source || \
              echo "Warning: Failed to rebuild $package"

              if [ -d "build/Release" ] && [ "$(ls -A build/Release 2>/dev/null)" ]; then
                echo "✅ $package built successfully"
                ls -la build/Release/
              else
                echo "❌ $package build failed or no output"
              fi

              cd ../..
            else
              echo "Package $package not found, skipping"
            fi
          done

      # Rebuild native modules for Electron
      - name: Rebuild native modules
        shell: bash
        run: |
          echo "Rebuilding native modules for ${{ matrix.arch }} on ${{ runner.os }}"
          npm rebuild better-sqlite3 --build-from-source
        env:
          npm_config_target_arch: ${{ matrix.arch }}
          npm_config_target: 35.2.1
          npm_config_runtime: electron
          npm_config_disturl: https://electronjs.org/headers
          npm_config_cache: ${{ runner.os == 'Windows' && 'C:\temp\.npm' || '/tmp/.npm' }}
          npm_config_build_from_source: true

      # Build using electron-forge
      - name: Make Electron app
        run: npm run make -- --arch=${{ matrix.arch }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # Clean up macOS keychain
      - name: Clean up keychain
        if: matrix.platform == 'mac' && always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ]; then
            security delete-keychain $KEYCHAIN_PATH || true
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            out/make/**/*.exe
            out/make/**/*.dmg
            out/make/**/*.deb
            out/make/**/*.rpm
            out/make/**/*.zip
          retention-days: 5

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: get_version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            echo "version=$INPUT_VERSION" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          fi
          echo "Using version: $(grep version "$GITHUB_OUTPUT" | cut -d'=' -f2)"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display structure of downloaded files
        run: ls -laR ./artifacts/

      - name: Delete existing release assets
        run: |
          TAG="${{ steps.get_version.outputs.version }}"
          echo "Checking for existing release with tag: $TAG"
          RELEASE_ID=$(gh api "repos/${{ github.repository }}/releases/tags/$TAG" --jq '.id' 2>/dev/null || echo "")
          if [ -n "$RELEASE_ID" ]; then
            echo "Found existing release (ID: $RELEASE_ID). Deleting all assets..."
            gh api "repos/${{ github.repository }}/releases/$RELEASE_ID/assets" --jq '.[].id' | while read ASSET_ID; do
              echo "Deleting asset ID: $ASSET_ID"
              gh api -X DELETE "repos/${{ github.repository }}/releases/assets/$ASSET_ID"
            done
            echo "All existing assets deleted."
          else
            echo "No existing release found for tag $TAG. Skipping asset cleanup."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Nav0 Browser ${{ steps.get_version.outputs.version }}
          body: |
            ## Nav0 Browser ${{ steps.get_version.outputs.version }}

            A minimal, privacy-focused web browser built on Electron.

            ### Downloads by Platform

            #### macOS
            - **Apple Silicon (ARM64)**: `.dmg` / `.zip`
            - **Intel (x64)**: `.dmg` / `.zip`

            #### Windows
            - **x64**: `.exe` installer

            #### Linux
            - **x64**: `.deb` (Debian/Ubuntu), `.rpm` (Fedora/RHEL)

            ### Installation
            - **Windows**: Run the `.exe` installer
            - **macOS**: Mount the `.dmg` and drag to Applications, or extract the `.zip`
              - If you see *"nav0-browser is damaged and can't be opened"*, run: `xattr -cr /Applications/nav0-browser.app`
            - **Linux**: Install the `.deb` or `.rpm` package
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            ./artifacts/**/*.exe
            ./artifacts/**/*.dmg
            ./artifacts/**/*.deb
            ./artifacts/**/*.rpm
            ./artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v4
        with:
          name: |
            macOS-x64
            macOS-arm64
            Linux-x64
            Windows-x64
